#!/usr/bin/env node
/**
 * SPOT Profile Configuration Generator for Frontend.
 * 
 * This script reads JSON files from the profile/ directory (Single Point of Truth)
 * and generates JavaScript/ES modules for the frontend:
 * - frontend/lib/profile-data.js - Complete profile data
 * - frontend/lib/phaseConfig.js - Pipeline phase configuration
 * - frontend/hooks/use-ai-settings.js - AI model configuration
 * 
 * Maintains backward compatibility with existing code while centralizing
 * configuration data for easier maintenance.
 * 
 * Usage:
 *     node scripts/generate-profile-config.js
 */

const fs = require('fs');
const path = require('path');

// =============================================================================
// Configuration
// =============================================================================

const WORKSPACE_ROOT = path.resolve(__dirname, '..');
const PROFILE_DIR = path.join(WORKSPACE_ROOT, 'profile');
const FRONTEND_DIR = path.join(WORKSPACE_ROOT, 'frontend');

const OUTPUT_FILES = {
  profileData: path.join(FRONTEND_DIR, 'lib', 'profile-data.js'),
  phaseConfig: path.join(FRONTEND_DIR, 'lib', 'phaseConfig.js'),
  aiSettings: path.join(FRONTEND_DIR, 'hooks', 'use-ai-settings.js'),
};

// =============================================================================
// JSON Loaders
// =============================================================================

/**
 * Load and parse a JSON file from the profile directory.
 * @param {string} filename - Name of the JSON file
 * @returns {object} Parsed JSON data
 */
function loadJson(filename) {
  const filePath = path.join(PROFILE_DIR, filename);
  if (!fs.existsSync(filePath)) {
    throw new Error(`Required profile file not found: ${filename}`);
  }
  
  const content = fs.readFileSync(filePath, 'utf-8');
  return JSON.parse(content);
}

/**
 * Load all profile JSON files.
 * @returns {object} All profile data
 */
function loadAllProfileData() {
  return {
    identity: loadJson('identity.json'),
    skills: loadJson('skills.json'),
    projects: loadJson('projects.json'),
    education: loadJson('education.json'),
    contact: loadJson('contact.json'),
    assets: loadJson('assets.json'),
    siteMetadata: loadJson('site_metadata.json'),
    aiModels: loadJson('ai_models.json'),
    pipelinePhases: loadJson('pipeline_phases.json'),
    experience: loadJson('experience.json'),
  };
}

// =============================================================================
// Code Generation - Profile Data
// =============================================================================

/**
 * Format a JavaScript object/array with proper indentation.
 * @param {any} data - Data to format
 * @param {number} indent - Current indentation level
 * @returns {string} Formatted string
 */
function formatJsValue(data, indent = 0) {
  const indentStr = '  '.repeat(indent);
  const nextIndentStr = '  '.repeat(indent + 1);
  
  if (data === null) return 'null';
  if (data === undefined) return 'undefined';
  
  if (typeof data === 'string') {
    // Escape special characters
    const escaped = data
      .replace(/\\/g, '\\\\')
      .replace(/'/g, "\\'")
      .replace(/\n/g, '\\n')
      .replace(/\r/g, '\\r')
      .replace(/\t/g, '\\t');
    return `'${escaped}'`;
  }
  
  if (typeof data === 'number' || typeof data === 'boolean') {
    return String(data);
  }
  
  if (Array.isArray(data)) {
    if (data.length === 0) return '[]';
    
    // Check if all items are simple strings
    if (data.every(item => typeof item === 'string')) {
      const items = data.map(item => formatJsValue(item, 0)).join(', ');
      return `[${items}]`;
    }
    
    // Complex array
    const items = data.map(item => 
      `${nextIndentStr}${formatJsValue(item, indent + 1)}`
    ).join(',\n');
    return `[\n${items}\n${indentStr}]`;
  }
  
  if (typeof data === 'object') {
    const keys = Object.keys(data);
    if (keys.length === 0) return '{}';
    
    const items = keys.map(key => {
      const value = formatJsValue(data[key], indent + 1);
      return `${nextIndentStr}${key}: ${value}`;
    }).join(',\n');
    
    return `{\n${items}\n${indentStr}}`;
  }
  
  return String(data);
}

/**
 * Generate the profile-data.js module.
 * @param {object} profileData - All profile data
 * @returns {string} Generated module content
 */
function generateProfileDataModule(profileData) {
  const { identity, skills, projects, education, contact, assets, siteMetadata, experience } = profileData;
  
  return `/**
 * Profile Data - AUTO-GENERATED
 * 
 * This module is AUTO-GENERATED from the profile/ directory (Single Point of Truth).
 * DO NOT EDIT THIS FILE DIRECTLY. Edit the JSON files in profile/ instead.
 * 
 * Source: scripts/generate-profile-config.js
 * Generated from: profile/*.json
 */

// =============================================================================
// Identity & Bio
// =============================================================================

export const IDENTITY = ${formatJsValue(identity, 0)};

// =============================================================================
// Skills & Technologies
// =============================================================================

export const SKILLS = ${formatJsValue(skills, 0)};

// =============================================================================
// Projects
// =============================================================================

export const PROJECTS = ${formatJsValue(projects, 0)};

// =============================================================================
// Education
// =============================================================================

export const EDUCATION = ${formatJsValue(education, 0)};

// =============================================================================
// Contact Information
// =============================================================================

export const CONTACT = ${formatJsValue(contact, 0)};

// =============================================================================
// Assets
// =============================================================================

export const ASSETS = ${formatJsValue(assets, 0)};

// =============================================================================
// Site Metadata
// =============================================================================

export const SITE_METADATA = ${formatJsValue(siteMetadata, 0)};

// =============================================================================
// Experience Timeline
// =============================================================================

export const EXPERIENCE = ${formatJsValue(experience, 0)};

// =============================================================================
// Convenience Exports
// =============================================================================

// API Configuration
export const API_BASE_URL = SITE_METADATA.deployment.api_base_url_dev;

// Hero Section
export const HERO_TEXT = {
  left: IDENTITY.hero.animation_left,
  right: IDENTITY.hero.animation_right,
};

// Skills for display
export const PRIMARY_SKILLS = SKILLS.display_categories.primary.skills;
export const DEVOPS_SKILLS = SKILLS.display_categories.devops.skills;

// Projects for display
export const FEATURED_PROJECTS = PROJECTS.featured;

// Education for display
export const PRIMARY_EDUCATION = EDUCATION.primary;

// Contact for display
export const EMAIL = CONTACT.email;
export const GITHUB_URL = CONTACT.social.github.url;
export const GITHUB_USERNAME = CONTACT.social.github.display;
export const REPO_URL = CONTACT.repo.url;

// Portrait
export const PORTRAIT_PATH = ASSETS.portrait;
export const PORTRAIT_ALT = IDENTITY.portrait.alt;

// Bio
export const BIO_TLDR = IDENTITY.bio.tldr;
export const BIO_FULL = IDENTITY.bio.full;
`;
}

// =============================================================================
// Code Generation - Phase Config
// =============================================================================

/**
 * Generate the phaseConfig.js module.
 * @param {object} profileData - All profile data
 * @returns {string} Generated module content
 */
function generatePhaseConfigModule(profileData) {
  const { pipelinePhases } = profileData;
  const phases = pipelinePhases.phases;
  
  // Map icon names to lucide-react imports
  const iconNames = new Set();
  Object.values(phases).forEach(phase => iconNames.add(phase.icon));
  const iconImports = Array.from(iconNames).sort().join(', ');
  
  // Generate phase config objects
  const phaseEntries = Object.entries(phases).map(([key, phase]) => {
    const color = phase.color;
    const intensity = phase.color_intensity;
    
    // For custom colors like 'burnt-peach', use direct class names
    const isCustom = phase.custom_color || false;
    const colorStr = isCustom ? color : `${color}-${intensity}`;
    const colorNextStr = isCustom ? color : `${color}-${intensity + 100}`;
    
    return `  ${key}: {
    label: '${phase.label}',
    icon: ${phase.icon},
    description: '${phase.description}',
    color: '${color}',
    borderColor: 'border-l-${colorStr}',
    bgColor: 'bg-${colorStr}',
    bgColorMuted: 'bg-${colorStr}/10',
    textColor: 'text-${colorStr}',
    ringColor: 'ring-${colorStr}/30',
    gradient: 'from-${colorStr} to-${colorNextStr}',
    gradientFrom: 'from-${colorStr}/10',
    gradientFromLight: 'from-${colorNextStr}/5',
    previewBorder: 'border-${colorStr}/50',
    glowRGB: '${phase.glow_rgb}',
  }`;
  }).join(',\n');
  
  const phaseOrderStr = pipelinePhases.phase_order.map(p => `'${p}'`).join(',\n  ');
  
  return `/**
 * Pipeline Phase Configuration - AUTO-GENERATED
 * 
 * This module is AUTO-GENERATED from the profile/ directory (Single Point of Truth).
 * DO NOT EDIT THIS FILE DIRECTLY. Edit profile/pipeline_phases.json instead.
 * 
 * Source: scripts/generate-profile-config.js
 * Generated from: profile/pipeline_phases.json
 * 
 * IMPORTANT: All class names must be complete static strings for Tailwind to compile them.
 * Dynamic template literals will NOT work with Tailwind's static analysis.
 */

import { ${iconImports} } from 'lucide-react';

/**
 * Centralized Phase Configuration for the Fit Check Pipeline.
 * Maps backend phase names to UI display properties and styling.
 */
export const PHASE_CONFIG = {
${phaseEntries}
};

/** Ordered list of pipeline phases */
export const PHASE_ORDER = [
  ${phaseOrderStr}
];
`;
}

// =============================================================================
// Code Generation - AI Settings
// =============================================================================

/**
 * Generate the use-ai-settings.js hook.
 * @param {object} profileData - All profile data
 * @returns {string} Generated module content
 */
function generateAiSettingsModule(profileData) {
  const { aiModels } = profileData;
  const models = aiModels.models;
  
  // Generate model entries
  const modelEntries = Object.entries(models).map(([key, model]) => {
    return `  '${key}': {
    id: '${model.id}',
    label: '${model.label}',
    description: '${model.description}',
    configType: '${model.config_type}',
    badge: '${model.badge}',
  }`;
  }).join(',\n');
  
  return `/**
 * AI Settings Hook - AUTO-GENERATED
 * 
 * This module is AUTO-GENERATED from the profile/ directory (Single Point of Truth).
 * DO NOT EDIT THIS FILE DIRECTLY. Edit profile/ai_models.json instead.
 * 
 * Source: scripts/generate-profile-config.js
 * Generated from: profile/ai_models.json
 */

'use client';

import { createContext, useContext, useState, useCallback } from 'react';

/**
 * AI Model Configuration
 * 
 * Model options with their specific configuration requirements.
 */
export const AI_MODELS = {
${modelEntries}
};

export const DEFAULT_MODEL = '${aiModels.default_model}';

/**
 * AI Settings Context
 * Provides global AI model configuration for the application.
 */
const AISettingsContext = createContext(null);

/**
 * AISettingsProvider Component
 * Wraps the application to provide AI model settings context.
 */
export function AISettingsProvider({ children }) {
  const [selectedModel, setSelectedModel] = useState(DEFAULT_MODEL);

  const updateModel = useCallback((modelId) => {
    if (AI_MODELS[modelId]) {
      setSelectedModel(modelId);
    }
  }, []);

  const getModelConfig = useCallback(() => {
    return AI_MODELS[selectedModel] || AI_MODELS[DEFAULT_MODEL];
  }, [selectedModel]);

  const value = {
    selectedModel,
    updateModel,
    getModelConfig,
    availableModels: Object.values(AI_MODELS),
  };

  return (
    <AISettingsContext.Provider value={value}>
      {children}
    </AISettingsContext.Provider>
  );
}

/**
 * useAISettings Hook
 * Access AI model settings from anywhere in the component tree.
 */
export function useAISettings() {
  const context = useContext(AISettingsContext);
  if (!context) {
    throw new Error('useAISettings must be used within an AISettingsProvider');
  }
  return context;
}
`;
}

// =============================================================================
// File Writing
// =============================================================================

/**
 * Write content to a file, creating directories if needed.
 * @param {string} filePath - Path to write to
 * @param {string} content - Content to write
 */
function writeFile(filePath, content) {
  const dir = path.dirname(filePath);
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }
  fs.writeFileSync(filePath, content, 'utf-8');
}

// =============================================================================
// Main Execution
// =============================================================================

function main() {
  console.log('='.repeat(70));
  console.log('SPOT Profile Configuration Generator - Frontend');
  console.log('='.repeat(70));
  console.log('');
  
  // Load all profile data
  console.log(`üìÇ Loading profile data from: ${PROFILE_DIR}`);
  let profileData;
  try {
    profileData = loadAllProfileData();
    console.log(`‚úÖ Successfully loaded ${Object.keys(profileData).length} profile files`);
  } catch (error) {
    console.error(`‚ùå Error: ${error.message}`);
    return 1;
  }
  
  // Generate and write profile-data.js
  console.log('\nüîß Generating profile-data.js...');
  try {
    const profileDataContent = generateProfileDataModule(profileData);
    writeFile(OUTPUT_FILES.profileData, profileDataContent);
    console.log(`‚úÖ Generated: ${path.relative(WORKSPACE_ROOT, OUTPUT_FILES.profileData)}`);
  } catch (error) {
    console.error(`‚ùå Error: ${error.message}`);
    return 1;
  }
  
  // Generate and write phaseConfig.js
  console.log('üîß Generating phaseConfig.js...');
  try {
    const phaseConfigContent = generatePhaseConfigModule(profileData);
    writeFile(OUTPUT_FILES.phaseConfig, phaseConfigContent);
    console.log(`‚úÖ Generated: ${path.relative(WORKSPACE_ROOT, OUTPUT_FILES.phaseConfig)}`);
  } catch (error) {
    console.error(`‚ùå Error: ${error.message}`);
    return 1;
  }
  
  // Generate and write use-ai-settings.js
  console.log('üîß Generating use-ai-settings.js...');
  try {
    const aiSettingsContent = generateAiSettingsModule(profileData);
    writeFile(OUTPUT_FILES.aiSettings, aiSettingsContent);
    console.log(`‚úÖ Generated: ${path.relative(WORKSPACE_ROOT, OUTPUT_FILES.aiSettings)}`);
  } catch (error) {
    console.error(`‚ùå Error: ${error.message}`);
    return 1;
  }
  
  console.log('');
  console.log('='.repeat(70));
  console.log('‚ú® Frontend configuration generated successfully!');
  console.log('='.repeat(70));
  return 0;
}

// Run the script
process.exit(main());
